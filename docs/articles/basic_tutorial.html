<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="qfm">
<title>Basic tutorial on Quantitative Fate Mapping (QFM) • qfm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Basic tutorial on Quantitative Fate Mapping (QFM)">
<meta property="og:description" content="qfm">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">qfm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/basic_tutorial.html">Basic tutorial on Quantitative Fate Mapping (QFM)</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Basic tutorial on Quantitative Fate Mapping (QFM)</h1>
                        <h4 data-toc-skip class="author">Weixiang
Fang</h4>
            
      
      
      <div class="d-none name"><code>basic_tutorial.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="read-example-data">Read example data<a class="anchor" aria-label="anchor" href="#read-example-data"></a>
</h3>
<p>In this example, we demonstrate quantitative fate mapping on lineage
barcode data measured with cell types. First, we apply Phylotime to
reconstruct time-scaled phylogeny from lineage barcodes. Second,
ICE-FASE is applied to extract parameters of progenitor population
dynamics, including commitment times, progenitor population sizes and
commitment biases.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># read mutant allele matrix</span></span>
<span><span class="va">cell_allele_table</span> <span class="op">=</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"../data/example/mutant_allele_matrix.csv"</span><span class="op">)</span></span>
<span><span class="va">cell_allele_table</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1,600 × 5</span></span></span>
<span><span class="co">##    cell         type  Site_1       Site_2 Site_3     </span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> Type1_Cell1  Type1 Site1_Mut22  0      Site3_Mut28</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> Type1_Cell2  Type1 Site1_Mut102 0      Site3_Mut1 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> Type1_Cell3  Type1 Site1_Mut2   0      Site3_Mut1 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> Type1_Cell4  Type1 0            0      Site3_Mut1 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> Type1_Cell5  Type1 0            0      Site3_Mut84</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> Type1_Cell6  Type1 0            0      Site3_Mut1 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> Type1_Cell7  Type1 0            0      Site3_Mut8 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> Type1_Cell8  Type1 Site1_Mut4   0      Site3_Mut13</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> Type1_Cell9  Type1 Site1_Mut22  0      Site3_Mut28</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> Type1_Cell10 Type1 Site1_Mut22  0      Site3_Mut28</span></span>
<span><span class="co">## <span style="color: #949494;"># … with 1,590 more rows</span></span></span></code></pre>
</div>
<div class="section level3">
<h3 id="running-phylotime">Running Phylotime<a class="anchor" aria-label="anchor" href="#running-phylotime"></a>
</h3>
<p>The input to Phylotime is a character matrix, with rows corresponding
to cells and columns corresponding to barcoding sites, tibble /
data.frame are convert to a character matrix. The matrix needs to have
rownames, which will be used as the names of the cells.</p>
<p>Within each barcoding site (column), the same character denotes a
unique mutant allele. The unmutated allele needs to be coded as the
character “0”. (zero) The user also needs to input the total amount of
active barcoding time, which is the duration for which mutations are
being actively generated.</p>
<p>Phylotime estimates mutation rate from data provided and assumes a
uniform allele emergence probability by default. More on how to set
user-defined mutation parameters when prior information is
available.</p>
<p>By default, Phylotime uses future to parallel pairwise distance
estimations, use plan to set up parallel method and number of workers.
Alternatively, set ‘parallel=F’.</p>
<p>In this example, barcoding activates at 0.6 days, and samples are
collected at 15 days.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chr_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">cell_allele_table</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">chr_mat</span><span class="op">)</span> <span class="op">=</span> <span class="va">cell_allele_table</span><span class="op">$</span><span class="va">cell</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/furrr" class="external-link">furrr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">tr</span> <span class="op">=</span> <span class="fu"><a href="../reference/phylotime.html">phylotime</a></span><span class="op">(</span><span class="va">chr_mat</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">]</span>, t_total <span class="op">=</span> <span class="fl">15.</span> <span class="op">-</span> <span class="fl">0.6</span><span class="op">)</span></span></code></pre></div>
<p>Now to visualize the reconstructed tree with the lineage
barcodes:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_barcodes</span><span class="op">(</span><span class="va">chr_mat</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">]</span>, <span class="va">tr</span>, show_column_names <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_tutorial_files/figure-html/unnamed-chunk-3-1.png" width="768"></p>
<p>To plot the reconstrcuted tree only:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_tr</span><span class="op">(</span><span class="va">tr</span>,</span>
<span>        end_alpha_terminal <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>        edge_width_terminal <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_tutorial_files/figure-html/unnamed-chunk-4-1.png" width="960"></p>
</div>
<div class="section level3">
<h3 id="running-ice-fase">Running ICE-FASE<a class="anchor" aria-label="anchor" href="#running-ice-fase"></a>
</h3>
<p>Next, to apply ICE-FASE, we need, in additional, the terminal cell
state classifications. This is provided as a named vector, where the
name correspond to cell names. We can visualzie the tree with terminal
cell states:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sc_celltypes</span> <span class="op">=</span> <span class="va">cell_allele_table</span><span class="op">$</span><span class="va">type</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sc_celltypes</span><span class="op">)</span> <span class="op">=</span> <span class="va">cell_allele_table</span><span class="op">$</span><span class="va">cell</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">sc_celltypes</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  Type1_Cell1  Type1_Cell2  Type1_Cell3  Type1_Cell4  Type1_Cell5  Type1_Cell6 </span></span>
<span><span class="co">##      "Type1"      "Type1"      "Type1"      "Type1"      "Type1"      "Type1" </span></span>
<span><span class="co">##  Type1_Cell7  Type1_Cell8  Type1_Cell9 Type1_Cell10 </span></span>
<span><span class="co">##      "Type1"      "Type1"      "Type1"      "Type1"</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_barcodes</span><span class="op">(</span><span class="va">chr_mat</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">]</span>, <span class="va">tr</span>, tip_celltype <span class="op">=</span> <span class="va">sc_celltypes</span>, show_column_names <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_tutorial_files/figure-html/unnamed-chunk-5-1.png" width="768"></p>
<p>To run ICE-FASE: (‘root_time’ is the time until barcode
activation.)</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">=</span> <span class="fu">ice_fase_mod</span><span class="op">(</span><span class="va">tr</span>, <span class="va">sc_celltypes</span>, total_time <span class="op">=</span> <span class="fl">15</span> <span class="op">-</span> <span class="fl">0.6</span>, root_time <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="ice-fase-results">ICE-FASE results<a class="anchor" aria-label="anchor" href="#ice-fase-results"></a>
</h3>
<p>With ICE-FASE fitted, a number of progenitor states are identified as
nodes in the fate map topology. We can plot the reconstructed fate map
topology with commitment times now. Note that the inferred progenitor
states (iP) are denoted as “Node-x” below.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_gr_clean</span><span class="op">(</span>gr <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">gr</span>,</span>
<span>              total_time <span class="op">=</span> <span class="fl">15</span>,</span>
<span>              gr_node_time <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">gr_trans_time</span>,</span>
<span>              type_col <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">col_pal</span>,</span>
<span>              show_node_label <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_tutorial_files/figure-html/unnamed-chunk-7-1.png" width="960"></p>
<p>To visualize the internal node state assignment in reconstructed
phylogeny:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_tr</span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">tr</span>,</span>
<span>        node_types <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">tr_node_assign</span>,</span>
<span>        type_col <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">col_pal</span>,</span>
<span>        end_alpha_terminal <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>        edge_width_terminal <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_tutorial_files/figure-html/unnamed-chunk-8-1.png" width="960">
To visualize distribution of Inferred Commitment Event (ICE) times:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_ice_times</span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: It is deprecated to specify `guide = FALSE` to remove a guide. Please</span></span>
<span><span class="co">## use `guide = "none"` instead.</span></span></code></pre>
<p><img src="basic_tutorial_files/figure-html/unnamed-chunk-9-1.png" width="768"></p>
<p>To visualize progenitor population sizes:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_node_sizes</span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: It is deprecated to specify `guide = FALSE` to remove a guide. Please</span></span>
<span><span class="co">## use `guide = "none"` instead.</span></span></code></pre>
<p><img src="basic_tutorial_files/figure-html/unnamed-chunk-10-1.png" width="768"></p>
<p>Finally, we can get a summary table for the progenitor state
estimates:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">output_estimates</span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 15 × 9</span></span></span>
<span><span class="co">##    progenitor_state commitment_time population_size downstream_state1</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> Node-1                      2.37              13 Node-2           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> Node-2                      5.03             149 Node-9           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> Node-3                      2.92              23 Node-4           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> Node-4                      5.08              95 Type6            </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> Node-5                      3.85              73 Node-6           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> Node-6                      5.50             101 Type7            </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> Node-7                      4.92             159 Type16           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> Node-8                      5.74             239 Type15           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> Node-9                      6.38             124 Type3            </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> Node-10                     5.92             133 Type2            </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">11</span> Node-11                     6.34             280 Type14           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">12</span> Node-12                     6.66             267 Type12           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">13</span> Node-13                     6.66             214 Type13           </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">14</span> Node-14                     6.97             182 Type9            </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">15</span> Node-15                     6.98             117 Type11           </span></span>
<span><span class="co">## <span style="color: #949494;"># … with 5 more variables: downstream_size1 &lt;dbl&gt;, downstream_state2 &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   downstream_size2 &lt;dbl&gt;, commitment_bias1 &lt;dbl&gt;, commitment_bias2 &lt;dbl&gt;</span></span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Weixiang Fang.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
